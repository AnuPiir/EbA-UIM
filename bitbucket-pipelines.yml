image: node:18

definitions:
  caches:
    npm: ~/.npm
    maven: ~/.m2
    node-modules: node_modules

pipelines:
  branches:
    master:
      - step:
          name: Build and Package App
          script:
            # Build backend with Maven
            - apt-get update && apt-get install -y maven
            - cd backend
            - mvn test
            - mvn clean package
            - cd ../frontend

            # Install frontend dependencies
            - npm install

            # Create jars directory and copy backend JAR
            - mkdir -p jars
            - cp ../backend/target/*.jar jars/

            # Build the Angular app
            - npm run build

            # Package for All
            - npm run package-everything
            # Zip the package for easier download
            - apt-get update && apt-get install -y zip
            - cd release-builds
            - zip -r EBAM-win32-x64.zip EBAM-win32-x64
            - zip -r EBAM-linux-x64.zip EBAM-linux-x64
            - zip -r EBAM-darwin-x64.zip EBAM-darwin-x64

            # Use Bitbucket's API to upload the zip files
            - pipe: atlassian/bitbucket-upload-file:0.3.2
              variables:
                BITBUCKET_USERNAME: $BITBUCKET_USERNAME
                BITBUCKET_APP_PASSWORD: $BITBUCKET_APP_PASSWORD
                FILENAME: 'EBAM-win32-x64.zip'

            - pipe: atlassian/bitbucket-upload-file:0.3.2
              variables:
                BITBUCKET_USERNAME: $BITBUCKET_USERNAME
                BITBUCKET_APP_PASSWORD: $BITBUCKET_APP_PASSWORD
                FILENAME: 'EBAM-linux-x64.zip'

            - pipe: atlassian/bitbucket-upload-file:0.3.2
              variables:
                BITBUCKET_USERNAME: $BITBUCKET_USERNAME
                BITBUCKET_APP_PASSWORD: $BITBUCKET_APP_PASSWORD
                FILENAME: 'EBAM-darwin-x64.zip'
          artifacts:
            - frontend/release-builds/**
    